<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — PY Crypto</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* GLOBAL FIXES -> remove horizontal scroll, safety sizing */
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden;box-sizing:border-box}
    *,*::before,*::after{box-sizing:inherit}
    img{max-width:100%;height:auto;display:block}
    input,textarea,select,button{max-width:100%;box-sizing:border-box}

    :root{
      --admin-card-bg: #ffffff;
      --admin-accent: #0b76d1;
      --muted-2: #6b7a83;
      --text: #0b2940;
      --news-collapse-lines: 5;
      --loader-bg: rgba(12,18,24,0.55);
    }

    .admin-container{max-width:1200px;margin:0 auto;padding:18px;}
    .admin-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .admin-header .brand{font-weight:800;color:var(--admin-accent);font-size:20px}
    .admin-header .meta{color:var(--muted-2);font-size:14px}

    .admin-top-nav{display:flex;gap:8px;align-items:center;margin-left:12px}
    .admin-top-nav .nav-btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;color:var(--admin-accent)}
    .admin-top-nav .nav-btn.active{background:linear-gradient(90deg,var(--admin-accent),#1fa9ff);color:#fff}

    .tx-block{background:var(--admin-card-bg);padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:16px}
    .tx-block .tx-head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .tx-wrap{margin-top:12px}

    .tx-table{width:100%;border-collapse:collapse}
    .tx-table th,.tx-table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    .tx-table thead th{background:transparent;color:var(--muted)}

    .tx-cards{display:none;flex-direction:column;gap:12px}
    .tx-card{background:linear-gradient(180deg,#fff,#fbfeff);padding:12px;border-radius:12px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(8,30,50,0.04)}
    .tx-card .row{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .tx-card .muted{color:var(--muted)}

    .two-col{display:grid;grid-template-columns:1fr 480px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .card h3{margin:0 0 8px}
    .form-row{display:flex;gap:8px}
    .form-row .col{flex:1}

    .img-preview{max-width:100%;height:auto;border-radius:8px;margin-top:10px;object-fit:cover}

    .news-item{display:flex;gap:12px;align-items:flex-start;padding:10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fbfeff)}
    .news-thumb{width:92px;height:64px;border-radius:8px;object-fit:cover;background:var(--soft);flex-shrink:0}

    .news-body{flex:1;min-width:0}
    .news-title{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700}
    .news-meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .news-desc{color:var(--muted);margin-top:4px;white-space:normal}

    /* collapse the content to N lines using max-height; supports both HTML with <br> and plain text (converted to <br>) */
    .news-content{
      margin-top:8px;
      color:var(--text);
      line-height:1.4;
      display:block;
      max-height: calc(var(--news-collapse-lines) * 1.4em);
      overflow:hidden;
      position:relative;
    }
    .news-toggle{
      display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;font-size:13px;margin-top:8px;
    }

    .rates-grid{display:flex;flex-direction:column;gap:8px}
    .rates-top{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .rates-search{padding:8px;border-radius:8px;border:1px solid var(--border);flex:1}

    .payments-grid{display:flex;flex-direction:column;gap:8px}
    .payments-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .payment-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fbfeff)}
    .payment-item .meta{font-size:13px;color:var(--muted)}
    .payment-form-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .payment-form-row input, .payment-form-row select { padding:8px;border-radius:8px;border:1px solid var(--border); }

    .tiny{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .tx-more{display:flex;justify-content:center;margin-top:10px}

    @media (min-width:1200px){
      .admin-container{max-width:1400px}
      .two-col{grid-template-columns:1fr 560px;gap:22px}
    }
    @media (max-width:1200px){
      .two-col{grid-template-columns:1fr 420px}
    }
    @media (max-width:1100px){
      .two-col{grid-template-columns:1fr}
      .admin-header{flex-direction:column;align-items:flex-start;gap:8px}
      .tx-table{display:none}
      .tx-cards{display:flex}
      .admin-header .meta{order:2}
      .admin-top-nav{margin-left:0;margin-top:8px}
    }
    @media (max-width:768px){
      .news-thumb{width:72px;height:56px}
      .tx-card .row{flex-direction:column;align-items:flex-start}
      .payment-form-row{flex-direction:column}
      .card, .payment-item, .news-item { word-break: break-word; min-width:0; }
      .news-content{max-height: calc(var(--news-collapse-lines) * 1.3em); }
    }
    @media (max-width:480px){
      .news-thumb{width:64px;height:48px}
      .admin-container{padding:12px}
    }

    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(12,18,24,0.45);z-index:20000;padding:18px}
    .modal .box{background:#fff;border-radius:12px;padding:16px;max-height:92vh;overflow:auto;box-shadow:0 18px 50px rgba(8,30,50,0.2);width:100%;max-width:900px}
    .modal .box .kv{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .modal .box .kv .col{flex:1;min-width:0}
    .modal .box .details{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
    .modal .box .details dt{font-weight:700}
    .modal .box .details dd{margin:0 0 8px}
    .status-chip{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
    .status-pending{background:#fff4e6;color:#a66a00;border:1px solid #ffe3b8}
    .status-approved{background:#e9fff2;color:#0b7b3b;border:1px solid #bff0c9}
    .status-rejected{background:#ffecec;color:#a22b2b;border:1px solid #ffc9c9}

    .admin-container, .card, form, .payment-item { width:100%; min-width:0; }

    .proof-preview{margin-top:12px;border:1px solid #eee;border-radius:8px;padding:8px;background:#fafafa}
    .proof-preview img{max-width:100%;height:auto;border-radius:6px;display:block}
    .proof-meta{font-size:13px;color:var(--muted);margin-top:6px}

    .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; border:1px solid var(--border); background:transparent; cursor:pointer; }

    /* GLOBAL LOADER (blocking overlay) */
    .global-loader {
      display:none;
      position: fixed;
      inset: 0;
      z-index: 99999;
      background: var(--loader-bg);
      align-items: center;
      justify-content: center;
      pointer-events: all;
    }
    .global-loader.active { display:flex; }
    .loader-box { background: #fff; padding: 20px 24px; border-radius: 12px; display:flex;gap:12px;align-items:center;box-shadow:0 12px 30px rgba(2,12,27,0.3) }
    .loader-spinner {
      width:36px;height:36px;border-radius:50%;border:4px solid #e6eef7;border-top-color:var(--admin-accent);animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-text { font-weight:700;color:#05324a }

  </style>
</head>
<body>
  <main class="admin-container">
    <!-- Header -->
    <header class="admin-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <div class="brand">PY Crypto — Admin</div>
          <div class="meta">Gérer news • taux • transactions • paiements</div>
        </div>

        <!-- Admin top nav -->
        <div class="admin-top-nav" role="navigation" aria-label="Admin navigation">
          <button class="nav-btn" data-target="rates-section">Taux & devises</button>
          <button class="nav-btn" data-target="news-section">News</button>
          <button class="nav-btn" data-target="transactions-section">Transactions</button>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div id="admin-username" class="tiny"></div>
        <button id="btn-logout" class="btn ghost">Déconnexion</button>
      </div>
    </header>

    <!-- Two column area: Left (news editor + list) / Right (rates + payments + quick actions) -->
    <section class="two-col" style="margin-top:16px">
      <!-- Left column -->
      <div id="news-section">
        <div class="card">
          <h3>Créer / Éditer une news</h3>
          <!-- enctype ajouté et names normalisés -->
          <form id="news-form" enctype="multipart/form-data" aria-label="Formulaire de publication d'actualité">
            <input type="hidden" id="n-id" name="id">
            <label class="tiny">Titre *</label>
            <input id="n-title" name="title" placeholder="Titre de la news" required style="padding:10px;border-radius:8px;border:1px solid var(--border)">

            <label class="tiny" style="margin-top:8px">Téléverser une image</label>
            <!-- name image ajouté pour correspondre à ce que le JS / serveur pourrait attendre -->
            <input id="n-file" name="image" type="file" accept="image/*" style="padding:6px" aria-label="Image de la news">

            <!-- preview and cloudinary url storage -->
            <img id="n-preview" class="img-preview" style="display:none" alt="Aperçu image news">
            <div id="n-image-meta" class="proof-preview" style="display:none">
              <div class="proof-meta"><strong>URL publique :</strong> <a id="n-image-url-link" href="#" target="_blank" rel="noopener"></a></div>
              <div class="proof-meta tiny" id="n-image-info"></div>
              <div style="margin-top:8px"><button id="n-image-remove" type="button" class="btn ghost">Supprimer l'image</button></div>
            </div>
            <input type="hidden" id="n-image-url" name="imageUrl">

            <label class="tiny" style="margin-top:8px">Description courte</label>
            <textarea id="n-desc" name="description" rows="2" style="padding:8px;border-radius:8px;border:1px solid var(--border)"></textarea>

            <label class="tiny" style="margin-top:8px">Contenu complet</label>
            <!-- agrandi -->
            <textarea id="n-content" name="content" rows="10" style="padding:8px;border-radius:8px;border:1px solid var(--border)"></textarea>

            <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
              <button id="publish-news" type="button" class="btn" aria-label="Publier la news">Publier</button>
              <button id="update-news" type="button" class="btn ghost" style="display:none" aria-label="Mettre à jour la news">Mettre à jour</button>
              <button id="clear-news" type="button" class="btn ghost" aria-label="Effacer le formulaire">Effacer</button>
              <div id="publish-status" class="tiny" style="margin-left:8px"></div>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>News publiées</h3>
          <div id="news-list" style="display:flex;flex-direction:column;gap:10px;margin-top:10px"></div>
        </div>
      </div>

      <!-- Right column -->
      <aside>
        <div class="card" id="rates-section">
          <h3>Taux & devises</h3>
          <div class="rates-top">
            <input id="rates-filter" class="rates-search" placeholder="Rechercher paire (ex: BTC-USD) ou partie (BTC)">
            <button id="rates-refresh" class="btn ghost">Rafraîchir</button>
          </div>
          <div id="rates-list" class="rates-grid tiny" style="margin-top:8px">Chargement...</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="r-pair" placeholder="Pair (ex: BTC-USD)" style="padding:8px;border-radius:8px;border:1px solid var(--border);flex:1">
            <input id="r-value" type="number" placeholder="Valeur" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:120px">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="r-add" class="btn">Ajouter / Modifier</button>
            <button id="btn-refresh" class="btn ghost">Rafraîchir news+taux+paiements</button>
          </div>

          <div style="margin-top:12px" class="tiny muted">Gérer les moyens de paiement ci-dessous</div>
        </div>

        <!-- Payment methods card (just under rates) -->
        <div class="card" style="margin-top:12px">
          <h3>Moyens de paiement</h3>

          <div style="margin-top:6px" class="tiny">Ajouter / éditer ou supprimer des moyens (crypto & fiat). Les changements sont stockés en base et affectent <code>/api/payments</code>.</div>

          <div class="payments-grid">
            <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
              <input id="pm-search" placeholder="Rechercher (nom / réseau)" style="padding:8px;border-radius:8px;border:1px solid var(--border);flex:1">
              <button id="pm-refresh" class="btn ghost">Rafraîchir</button>
            </div>

            <div id="payments-list" class="payments-list tiny" style="margin-top:8px">
              Chargement...
            </div>

            <div style="margin-top:10px;border-top:1px dashed var(--border);padding-top:8px">
              <h4 style="margin:0 0 8px">Ajouter / Modifier un moyen</h4>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="pm-id" type="hidden" name="pmId">
                <input id="pm-name" name="pmName" placeholder="Nom (ex: Moov Money / Adresse BTC)" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)">
              </div>
              <div class="payment-form-row" style="margin-top:8px">
                <select id="pm-type" name="pmType" style="width:140px">
                  <option value="fiat">fiat</option>
                  <option value="crypto">crypto</option>
                </select>
                <input id="pm-network" name="pmNetwork" placeholder="Réseau (ex: BEP20 / TRC20) — laissez vide pour fiat" style="min-width:140px">
                <input id="pm-details" name="pmDetails" placeholder="Détails: N° de compte ou adresse" style="flex:1">
                <label style="display:flex;align-items:center;gap:8px;margin-left:6px">
                  <input id="pm-active" type="checkbox" checked name="pmActive"> Actif
                </label>
              </div>

              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                <button id="pm-clear" class="btn ghost">Effacer</button>
                <button id="pm-save" class="btn">Enregistrer</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Actions rapides</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button id="btn-load-news" class="btn ghost">Recharger news</button>
            <button id="btn-seed-sample" class="btn ghost">Seed d'exemple</button>
          </div>
        </div>
      </aside>
    </section>

    <!-- Transactions full width -->
    <section id="transactions-section" class="tx-block card" aria-labelledby="tx-title">
      <div class="tx-head">
        <h3 id="tx-title">Transactions récentes</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="tx-filter" placeholder="Rechercher utilisateur / statut / pair" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
          <button id="btn-refresh-tx" class="btn ghost">Rafraîchir</button>
        </div>
      </div>

      <div class="tx-wrap">
        <!-- Desktop table -->
        <table class="tx-table" id="tx-table" aria-live="polite">
          <thead>
            <tr><th>Date</th><th>User</th><th>Type</th><th>Pair</th><th>Montant</th><th>Reçu</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="tx-tbody">
            <tr><td colspan="8" class="tiny">Chargement...</td></tr>
          </tbody>
        </table>

        <!-- Mobile cards -->
        <div id="tx-cards" class="tx-cards"></div>

        <div class="tx-more">
          <button id="tx-load-more" class="btn ghost" style="display:none">Voir plus</button>
        </div>
      </div>
    </section>

    <footer style="margin-top:18px" class="tiny muted">© PY Crypto — Admin</footer>
  </main>

  <!-- GLOBAL BLOCKING LOADER -->
  <div id="global-loader" class="global-loader" aria-hidden="true">
    <div class="loader-box" role="status" aria-live="polite">
      <div class="loader-spinner" aria-hidden="true"></div>
      <div class="loader-text" id="global-loader-text">Traitement en cours…</div>
    </div>
  </div>
  <!-- Socket client -->
  <script src="/socket.io/socket.io.js"></script>

  <script src="/js/admin.js"></script>
</body>
</html>
