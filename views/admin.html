<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — PY Crypto</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* GLOBAL FIXES -> remove horizontal scroll, safety sizing */
    html,body{height:100%;margin:0;padding:0;overflow-x:hidden;box-sizing:border-box}
    *,*::before,*::after{box-sizing:inherit}
    img{max-width:100%;height:auto;display:block}
    input,textarea,select,button{max-width:100%;box-sizing:border-box}

    /* ===== Admin additions (kept in same theme) ===== */
    :root{
      --admin-card-bg: #ffffff;
      --admin-accent: #0b76d1;
      --muted-2: #6b7a83;
    }

    .admin-container{max-width:1200px;margin:0 auto;padding:18px;}
    .admin-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
    .admin-header .brand{font-weight:800;color:var(--admin-accent);font-size:20px}
    .admin-header .meta{color:var(--muted-2);font-size:14px}

    /* Admin top nav */
    .admin-top-nav{display:flex;gap:8px;align-items:center;margin-left:12px}
    .admin-top-nav .nav-btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;color:var(--admin-accent)}
    .admin-top-nav .nav-btn.active{background:linear-gradient(90deg,var(--admin-accent),#1fa9ff);color:#fff}

    /* Transactions full width block */
    .tx-block{background:var(--admin-card-bg);padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:16px}
    .tx-block .tx-head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .tx-wrap{margin-top:12px}

    /* Table style (desktop) */
    .tx-table{width:100%;border-collapse:collapse}
    .tx-table th,.tx-table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    .tx-table thead th{background:transparent;color:var(--muted)}

    /* Card view (mobile) */
    .tx-cards{display:none;flex-direction:column;gap:12px}
    .tx-card{background:linear-gradient(180deg,#fff,#fbfeff);padding:12px;border-radius:12px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(8,30,50,0.04)}
    .tx-card .row{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    .tx-card .muted{color:var(--muted)}

    /* News editor & list */
    .two-col{display:grid;grid-template-columns:1fr 480px;gap:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden}
    .card h3{margin:0 0 8px}
    .form-row{display:flex;gap:8px}
    .form-row .col{flex:1}

    .img-preview{max-width:100%;height:auto;border-radius:8px;margin-top:10px;object-fit:cover}

    /* news list item */
    .news-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fbfeff)}
    .news-thumb{width:92px;height:64px;border-radius:8px;object-fit:cover;background:var(--soft);flex-shrink:0}

    /* Rates */
    .rates-grid{display:flex;flex-direction:column;gap:8px}
    .rates-top{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .rates-search{padding:8px;border-radius:8px;border:1px solid var(--border);flex:1}

    /* Payments section */
    .payments-grid{display:flex;flex-direction:column;gap:8px}
    .payments-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .payment-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;border:1px solid var(--border);background:linear-gradient(180deg,#fff,#fbfeff)}
    .payment-item .meta{font-size:13px;color:var(--muted)}
    .payment-form-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .payment-form-row input, .payment-form-row select { padding:8px;border-radius:8px;border:1px solid var(--border); }

    /* helpers */
    .tiny{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px}

    /* "Voir plus" */
    .tx-more{display:flex;justify-content:center;margin-top:10px}

    /* responsive adjustments */
    @media (min-width:1200px){
      /* give right column more space on large screens */
      .admin-container{max-width:1400px}
      .two-col{grid-template-columns:1fr 560px;gap:22px}
    }
    @media (max-width:1200px){
      .two-col{grid-template-columns:1fr 420px}
    }
    @media (max-width:1100px){
      .two-col{grid-template-columns:1fr}
      .admin-header{flex-direction:column;align-items:flex-start;gap:8px}
      .tx-table{display:none}
      .tx-cards{display:flex}
      .admin-header .meta{order:2}
      .admin-top-nav{margin-left:0;margin-top:8px}
    }
    @media (max-width:480px){
      .news-thumb{width:72px;height:56px}
      .tx-card .row{flex-direction:column;align-items:flex-start}
      .payment-form-row{flex-direction:column}
      /* prevent overflow from long text or inputs */
      .card, .payment-item, .news-item { word-break: break-word; min-width:0; }
    }

    /* small improvements for modal content */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(12,18,24,0.45);z-index:20000;padding:18px}
    .modal .box{background:#fff;border-radius:12px;padding:16px;max-height:92vh;overflow:auto;box-shadow:0 18px 50px rgba(8,30,50,0.2);width:100%;max-width:900px}
    .modal .box .kv{display:flex;justify-content:space-between;gap:12px}
    .modal .box .kv .col{flex:1}
    .modal .box .details{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
    .modal .box .details dt{font-weight:700}
    .modal .box .details dd{margin:0 0 8px}
    .status-chip{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
    .status-pending{background:#fff4e6;color:#a66a00;border:1px solid #ffe3b8}
    .status-approved{background:#e9fff2;color:#0b7b3b;border:1px solid #bff0c9}
    .status-rejected{background:#ffecec;color:#a22b2b;border:1px solid #ffc9c9}

    /* small UI tweaks to avoid horizontal overflow */
    .admin-container, .card, form, .payment-item { width:100%; min-width:0; }
  </style>
</head>
<body>
  <main class="admin-container">
    <!-- Header -->
    <header class="admin-header">
      <div style="display:flex;align-items:center;gap:12px">
        <div>
          <div class="brand">PY Crypto — Admin</div>
          <div class="meta">Gérer news • taux • transactions • paiements</div>
        </div>

        <!-- Admin top nav -->
        <div class="admin-top-nav" role="navigation" aria-label="Admin navigation">
          <button class="nav-btn" data-target="rates-section">Taux & devises</button>
          <button class="nav-btn" data-target="news-section">News</button>
          <button class="nav-btn" data-target="transactions-section">Transactions</button>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div id="admin-username" class="tiny"></div>
        <button id="btn-logout" class="btn ghost">Déconnexion</button>
      </div>
    </header>

    <!-- Two column area: Left (news editor + list) / Right (rates + payments + quick actions) -->
    <section class="two-col" style="margin-top:16px">
      <!-- Left column -->
      <div id="news-section">
        <div class="card">
          <h3>Créer / Éditer une news</h3>
          <form id="news-form">
            <input type="hidden" id="n-id">
            <label class="tiny">Titre *</label>
            <input id="n-title" placeholder="Titre de la news" required style="padding:10px;border-radius:8px;border:1px solid var(--border)">

            <label class="tiny" style="margin-top:8px">Téléverser une image</label>
            <input id="n-file" type="file" accept="image/*" style="padding:6px">

            <img id="n-preview" class="img-preview" style="display:none">

            <label class="tiny" style="margin-top:8px">Description courte</label>
            <textarea id="n-desc" rows="2" style="padding:8px;border-radius:8px;border:1px solid var(--border)"></textarea>

            <label class="tiny" style="margin-top:8px">Contenu complet</label>
            <textarea id="n-content" rows="6" style="padding:8px;border-radius:8px;border:1px solid var(--border)"></textarea>

            <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
              <button id="publish-news" type="button" class="btn">Publier</button>
              <button id="update-news" type="button" class="btn ghost" style="display:none">Mettre à jour</button>
              <button id="clear-news" type="button" class="btn ghost">Effacer</button>
              <div id="publish-status" class="tiny" style="margin-left:8px"></div>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>News publiées</h3>
          <div id="news-list" style="display:flex;flex-direction:column;gap:10px;margin-top:10px"></div>
        </div>
      </div>

      <!-- Right column -->
      <aside>
        <div class="card" id="rates-section">
          <h3>Taux & devises</h3>
          <div class="rates-top">
            <input id="rates-filter" class="rates-search" placeholder="Rechercher paire (ex: BTC-USD) ou partie (BTC)">
            <button id="rates-refresh" class="btn ghost">Rafraîchir</button>
          </div>
          <div id="rates-list" class="rates-grid tiny" style="margin-top:8px">Chargement...</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="r-pair" placeholder="Pair (ex: BTC-USD)" style="padding:8px;border-radius:8px;border:1px solid var(--border);flex:1">
            <input id="r-value" type="number" placeholder="Valeur" style="padding:8px;border-radius:8px;border:1px solid var(--border);width:120px">
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="r-add" class="btn">Ajouter / Modifier</button>
            <button id="btn-refresh" class="btn ghost">Rafraîchir news+taux+paiements</button>
          </div>

          <div style="margin-top:12px" class="tiny muted">Gérer les moyens de paiement ci-dessous</div>
        </div>

        <!-- Payment methods card (just under rates) -->
        <div class="card" style="margin-top:12px">
          <h3>Moyens de paiement</h3>

          <div style="margin-top:6px" class="tiny">Ajouter / éditer ou supprimer des moyens (crypto & fiat). Les changements sont stockés en base et affectent <code>/api/payments</code>.</div>

          <div class="payments-grid">
            <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
              <input id="pm-search" placeholder="Rechercher (nom / réseau)" style="padding:8px;border-radius:8px;border:1px solid var(--border);flex:1">
              <button id="pm-refresh" class="btn ghost">Rafraîchir</button>
            </div>

            <div id="payments-list" class="payments-list tiny" style="margin-top:8px">
              Chargement...
            </div>

            <div style="margin-top:10px;border-top:1px dashed var(--border);padding-top:8px">
              <h4 style="margin:0 0 8px">Ajouter / Modifier un moyen</h4>
              <div style="display:flex;gap:8px;align-items:center">
                <input id="pm-id" type="hidden">
                <input id="pm-name" placeholder="Nom (ex: Moov Money / Adresse BTC)" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--border)">
              </div>
              <div class="payment-form-row" style="margin-top:8px">
                <select id="pm-type" style="width:140px">
                  <option value="fiat">fiat</option>
                  <option value="crypto">crypto</option>
                </select>
                <input id="pm-network" placeholder="Réseau (ex: BEP20 / TRC20) — laissez vide pour fiat" style="min-width:140px">
                <input id="pm-details" placeholder="Détails: N° de compte ou adresse" style="flex:1">
                <label style="display:flex;align-items:center;gap:8px;margin-left:6px">
                  <input id="pm-active" type="checkbox" checked> Actif
                </label>
              </div>

              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                <button id="pm-clear" class="btn ghost">Effacer</button>
                <button id="pm-save" class="btn">Enregistrer</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Actions rapides</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button id="btn-load-news" class="btn ghost">Recharger news</button>
            <button id="btn-seed-sample" class="btn ghost">Seed d'exemple</button>
          </div>
        </div>
      </aside>
    </section>
    

    <!-- Transactions full width -->
    <section id="transactions-section" class="tx-block card" aria-labelledby="tx-title">
      <div class="tx-head">
        <h3 id="tx-title">Transactions récentes</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="tx-filter" placeholder="Rechercher utilisateur / statut / pair" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
          <button id="btn-refresh-tx" class="btn ghost">Rafraîchir</button>
        </div>
      </div>

      <div class="tx-wrap">
        <!-- Desktop table -->
        <table class="tx-table" id="tx-table" aria-live="polite">
          <thead>
            <tr><th>Date</th><th>User</th><th>Type</th><th>Pair</th><th>Montant</th><th>Reçu</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="tx-tbody">
            <tr><td colspan="8" class="tiny">Chargement...</td></tr>
          </tbody>
        </table>

        <!-- Mobile cards -->
        <div id="tx-cards" class="tx-cards"></div>

        <div class="tx-more">
          <button id="tx-load-more" class="btn ghost" style="display:none">Voir plus</button>
        </div>
      </div>
    </section>

    <footer style="margin-top:18px" class="tiny muted">© PY Crypto — Admin</footer>
  </main>

  <!-- Socket client -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
  /* ===================
     admin front JS (updated)
     - fixes:
       * modal status update used wrong id -> now uses tx._id or tx.id fallback
       * delegated event binding for payments/news actions (immediate and robust)
       * removed horizontal scroll on mobile + overflow handling
       * extra guards for missing ids and better logging
     - endpoints used: /admin/upload, /admin/news, /admin/transactions, /admin/transactions/:id, /admin/transactions/:id/status, /api/rates, /admin/payment-methods, /api/payments
     =================== */

  (function(){
    // helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function toast(msg, ok=true){
      const t = document.createElement('div');
      t.style.position='fixed'; t.style.right='18px'; t.style.bottom='20px';
      t.style.background = ok ? 'linear-gradient(90deg,#17a063,#15b36a)' : 'linear-gradient(90deg,#e14b4b,#d83a3a)';
      t.style.color='#fff'; t.style.padding='10px 14px'; t.style.borderRadius='10px'; t.style.zIndex=99999;
      t.innerText = msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
    }
    function authFetch(url, opts = {}) {
      opts.headers = opts.headers || {};
      const token = localStorage.getItem('token');
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      return fetch(url, opts);
    }

    // token check
    const token = localStorage.getItem('token');
    if(!token){ alert('Accès admin requis. Connecte-toi.'); window.location.href='/login_admin'; }
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if(user && user.username) $('#admin-username').innerText = user.username;

    // socket
    try {
      const socket = io();
      socket.on('connect', ()=> console.log('socket connected', socket.id));
      socket.on('newTransaction', ()=> { loadTransactions(); toast('Nouvelle transaction'); });
      socket.on('txStatusChanged', ()=> { loadTransactions(); toast('Statut transaction changé'); });
    } catch(e){ console.warn('socket init failed', e); }

    // DOM refs
    const txTbody = $('#tx-tbody'), txCards = $('#tx-cards'), txFilter = $('#tx-filter'), btnRefreshTx = $('#btn-refresh-tx');
    const publishBtn = $('#publish-news'), updateBtn = $('#update-news'), clearBtn = $('#clear-news'), publishStatus = $('#publish-status');
    const nFile = $('#n-file'), nPreview = $('#n-preview'), nTitle = $('#n-title'), nDesc = $('#n-desc'), nContent = $('#n-content'), nId = $('#n-id');
    const newsList = $('#news-list'), btnLoadNews = $('#btn-load-news'), btnSeed = $('#btn-seed-sample');
    const ratesList = $('#rates-list'), rPair = $('#r-pair'), rValue = $('#r-value'), rAdd = $('#r-add'), btnRefresh = $('#btn-refresh');
    const ratesFilter = $('#rates-filter'), ratesRefreshBtn = $('#rates-refresh');

    // Payments DOM refs
    const pmListEl = $('#payments-list'), pmSearch = $('#pm-search'), pmRefresh = $('#pm-refresh');
    const pmId = $('#pm-id'), pmName = $('#pm-name'), pmType = $('#pm-type'), pmNetwork = $('#pm-network'), pmDetails = $('#pm-details'), pmActive = $('#pm-active');
    const pmSave = $('#pm-save'), pmClear = $('#pm-clear');

    // Upload helper (POST /admin/upload)
    async function uploadFileToServer(file){
      if(!file) return null;
      const fd = new FormData();
      fd.append('file', file);
      const token = localStorage.getItem('token');
      const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
      const res = await fetch('/admin/upload', { method: 'POST', headers, body: fd });
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch(e) { throw new Error('Upload failed (non-JSON response): ' + (text || '(empty)')); }
      if(!res.ok || !json.success){
        const errText = (json.error && (typeof json.error === 'string' ? json.error : (json.error.message||JSON.stringify(json.error)))) || json.message || ('status ' + res.status);
        throw new Error('Upload failed: ' + errText);
      }
      return { url: json.url, public_id: json.public_id || null };
    }

    /* ---------------------------
       Transactions (client-side pagination)
       --------------------------- */
    let transactionsCache = []; // full list returned by /admin/transactions
    let txPage = 0;
    const TX_PAGE_SIZE = 10;

    async function loadTransactions(){
      try {
        const res = await authFetch('/admin/transactions');
        if(!res.ok) throw new Error('Impossible de charger transactions');
        const txs = await res.json();
        transactionsCache = Array.isArray(txs) ? txs : [];
        txPage = 0;
        renderTransactionsPage();
      } catch(e){
        console.error(e); txTbody.innerHTML = '<tr><td colspan="8" class="tiny">Erreur chargement</td></tr>'; txCards.innerHTML = '';
      }
    }

    function renderTransactionsPage(append=false){
      const q = txFilter.value.trim().toLowerCase();
      const filtered = transactionsCache.filter(t => {
        if(!q) return true;
        const u = (t.user && (t.user.username||t.user.email)) || 'guest';
        return String(u).toLowerCase().includes(q) || String(t.status||'').toLowerCase().includes(q) || ((t.from||'') + ' ' + (t.to||'')).toLowerCase().includes(q);
      });

      const end = (txPage + 1) * TX_PAGE_SIZE;
      const pageItems = filtered.slice(0, end);

      // desktop table
      if(pageItems.length === 0){
        txTbody.innerHTML = '<tr><td colspan="8" class="tiny">Aucune transaction</td></tr>';
      } else {
        txTbody.innerHTML = pageItems.map(t => {
          const u = t.user ? (t.user.username || t.user.email) : 'Guest';
          const id = t._id || t.id || '';
          return `<tr data-txid="${escapeHtml(id)}">
            <td>${new Date(t.createdAt).toLocaleString()}</td>
            <td>${escapeHtml(u)}</td>
            <td>${escapeHtml(t.type||'')}</td>
            <td>${escapeHtml((t.from||'') + ' → ' + (t.to||''))}</td>
            <td>${escapeHtml(String(t.amountFrom||''))}</td>
            <td>${escapeHtml(String(t.amountTo||''))}</td>
            <td>${renderStatusChip(t.status||'')}</td>
            <td>
              <div class="actions">
                <button class="btn ghost" data-id="${id}" data-action="view">Voir</button>
                <button class="btn" data-id="${id}" data-action="approve">Valider</button>
                <button class="btn ghost" data-id="${id}" data-action="reject">Rejeter</button>
              </div>
            </td>
          </tr>`; }).join('');
      }

      // cards (mobile)
      txCards.innerHTML = pageItems.map(t => {
        const u = t.user ? (t.user.username || t.user.email) : 'Guest';
        const id = t._id || t.id || '';
        return `<div class="tx-card" data-txid="${escapeHtml(id)}">
          <div class="row"><strong>${escapeHtml(u)}</strong><span class="tiny muted">${new Date(t.createdAt).toLocaleString()}</span></div>
          <div class="row"><span>Pair: <strong>${escapeHtml((t.from||'') + '→' + (t.to||''))}</strong></span><span>Status: <strong>${escapeHtml(t.status||'')}</strong></span></div>
          <div class="row"><span>Montant: ${escapeHtml(String(t.amountFrom||''))}</span><span>Reçu: ${escapeHtml(String(t.amountTo||''))}</span></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost" data-id="${id}" data-action="view">Voir</button>
            <button class="btn" data-id="${id}" data-action="approve">Valider</button>
            <button class="btn ghost" data-id="${id}" data-action="reject">Rejeter</button>
          </div>
        </div>`;
      }).join('');

      // show/hide "Voir plus"
      const filteredCount = filtered.length;
      const loadMoreBtn = $('#tx-load-more');
      if(end < filteredCount){
        loadMoreBtn.style.display = 'inline-block';
      } else {
        loadMoreBtn.style.display = 'none';
      }
    }

    // delegate tx actions (works for both table and cards)
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-action]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-action');
      if(!id) return toast('ID transaction introuvable', false);
      if(act === 'view') return viewTx(id);
      if(act === 'approve') return setStatus(id, 'approved');
      if(act === 'reject') return setStatus(id, 'rejected');
    });

    function renderStatusChip(status){
      const s = String(status || '').toLowerCase();
      if(s === 'approved') return `<span class="status-chip status-approved">${escapeHtml(status)}</span>`;
      if(s === 'rejected') return `<span class="status-chip status-rejected">${escapeHtml(status)}</span>`;
      return `<span class="status-chip status-pending">${escapeHtml(status || 'pending')}</span>`;
    }

    // "Voir plus" handler
    $('#tx-load-more').addEventListener('click', () => {
      txPage++;
      renderTransactionsPage(true);
    });

    txFilter.addEventListener('input', () => { txPage = 0; renderTransactionsPage(); });

    // escape
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* ---------------------------
       Transaction modal (readable) + status update fix
       --------------------------- */
    window.viewTx = async function(id){
      try {
        const res = await authFetch('/admin/transactions/' + id);
        if(!res.ok) {
          const txt = await res.text().catch(()=>null);
          throw new Error('Impossible de charger transaction: ' + (txt||res.status));
        }
        const tx = await res.json();

        const modal = document.createElement('div'); modal.className='modal';
        const box = document.createElement('div'); box.className='box';
        box.style.maxWidth='720px';

        // build user html
        let userHtml = '<div class="tiny muted">Guest</div>';
        if(tx.user){
          const u = tx.user.username || tx.user.email || '';
          userHtml = `<div><strong>${escapeHtml(u)}</strong><div class="tiny muted">${escapeHtml(tx.user.email||'')}</div></div>`;
        }

        // build details list (object -> readable)
        const det = tx.details || {};
        let detHtml = '';
        if(Object.keys(det).length === 0){
          detHtml = '<div class="small muted">Aucun détail fourni</div>';
        } else {
          detHtml = '<dl class="details">';
          for(const k of Object.keys(det)){
            const val = det[k] === null || typeof det[k] === 'undefined' ? '' : String(det[k]);
            const safeVal = escapeHtml(val).replace(/\n/g,'<br>').replace(/&lt;br&gt;/g, '<br>');
            detHtml += `<dt>${escapeHtml(k)}</dt><dd>${safeVal}</dd>`;
          }
          detHtml += '</dl>';
        }

        // ensure we have an id to use
        const txId = tx._id || tx.id || id;

        box.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Détails transaction</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="modal-status-select" style="padding:6px;border-radius:8px;border:1px solid var(--border)">
                <option value="pending">pending</option>
                <option value="approved">approved</option>
                <option value="rejected">rejected</option>
                <option value="cancelled">cancelled</option>
              </select>
              <button class="btn" id="modal-save-status">Enregistrer</button>
              <button class="btn ghost" id="close-x">Fermer</button>
            </div>
          </div>

          <div style="display:flex;gap:12px;margin-top:10px">
            <div style="flex:1">
              <div class="kv"><div class="col">${userHtml}</div><div class="col tiny muted">${new Date(tx.createdAt).toLocaleString()}</div></div>
              <div style="margin-top:8px"><strong>Pair:</strong> ${escapeHtml((tx.from||'') + ' → ' + (tx.to||''))}</div>
              <div style="margin-top:6px"><strong>Type:</strong> ${escapeHtml(tx.type||'')}</div>
              <div style="margin-top:6px"><strong>Montant:</strong> ${escapeHtml(String(tx.amountFrom||''))} → <strong>${escapeHtml(String(tx.amountTo||''))}</strong></div>
              <div style="margin-top:8px">${renderStatusChip(tx.status)}</div>
            </div>
          </div>

          <div class="details" style="margin-top:12px">
            <h4>Détails fournis</h4>
            ${detHtml}
          </div>
        `;

        modal.appendChild(box); document.body.appendChild(modal);
        box.querySelector('#close-x').onclick = ()=> modal.remove();
        modal.onclick = (e)=> { if(e.target === modal) modal.remove(); };

        // set status select to current
        const sel = box.querySelector('#modal-status-select');
        if(sel) sel.value = tx.status || 'pending';

        box.querySelector('#modal-save-status').onclick = async () => {
          const newStatus = sel.value;
          if(!confirm('Confirmer la mise à jour du statut ?')) return;
          if(!txId){ toast('ID transaction introuvable', false); return; }
          try {
            const resp = await authFetch(`/admin/transactions/${txId}/status`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ status: newStatus }) });
            const body = await resp.json().catch(()=>null);
            if(resp.ok && body && body.success){ toast('Statut mis à jour'); loadTransactions(); modal.remove(); }
            else { console.error('status update failed', resp, body); toast('Erreur mise à jour', false); }
          } catch(e){ console.error(e); toast('Erreur', false); }
        };

      } catch(e){ console.error('viewTx err', e); toast('Erreur chargement détail', false); }
    };

    /* ---------------------------
       setStatus shortcut (admin)
       --------------------------- */
    window.setStatus = async function(id, status){
      if(!confirm('Confirmer la mise à jour du statut ?')) return;
      if(!id){ toast('ID transaction introuvable', false); return; }
      try {
        const res = await authFetch(`/admin/transactions/${id}/status`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ status }) });
        const body = await res.json().catch(()=>null);
        if(res.ok && body && body.success){ toast('Statut mis à jour'); loadTransactions(); } else { console.error('setStatus failed', res, body); toast('Erreur', false); }
      } catch(e){ console.error(e); toast('Erreur', false); }
    };

    /* ---------------------------
       NEWS logic (with \n -> <br> handling)
       - use delegated events for edit/delete to avoid race conditions
       --------------------------- */
    nFile.addEventListener('change', () => {
      const f = nFile.files[0];
      if(!f){ nPreview.style.display='none'; nPreview.src=''; return; }
      nPreview.src = URL.createObjectURL(f); nPreview.style.display='block';
      nPreview.onload = ()=> URL.revokeObjectURL(nPreview.src);
    });

    function clearNewsForm(){
      nId.value=''; nTitle.value=''; nDesc.value=''; nContent.value='';
      nFile.value=''; nPreview.style.display='none';
      publishBtn.style.display='inline-block'; updateBtn.style.display='none';
    }
    clearBtn.addEventListener('click', clearNewsForm);

    function textToHtmlWithBr(text){
      if(!text) return '';
      return String(text).replace(/\r\n/g,'\n').replace(/\n/g, '<br>');
    }
    function htmlBrToText(html){
      if(!html) return '';
      return String(html).replace(/<br\s*\/?>/gi, '\n');
    }

    publishBtn.addEventListener('click', async () => {
      const title = nTitle.value.trim(); if(!title){ alert('Titre requis'); return; }
      publishBtn.disabled = true; publishStatus.innerText = 'Publication...';
      try {
        let imageUrl = '', publicId = '';
        if(nFile.files && nFile.files[0]){
          const up = await uploadFileToServer(nFile.files[0]);
          imageUrl = up.url; publicId = up.public_id;
        }
        const body = {
          title,
          description: textToHtmlWithBr(nDesc.value.trim()),
          content: textToHtmlWithBr(nContent.value.trim()),
          image: imageUrl,
          image_public_id: publicId
        };
        const res = await authFetch('/admin/news', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){ toast('Publication réussie'); clearNewsForm(); loadNews(); } else { console.error('publish failed', res, j); toast('Erreur publication', false); alert((j && j.message) || 'Erreur'); }
      } catch(err){ console.error(err); toast('Erreur upload/publication', false); alert(String(err)); }
      finally{ publishBtn.disabled=false; publishStatus.innerText=''; }
    });

    // update
    window.editNews = function(id){
      const found = window.__newsCache && window.__newsCache.find(n => (n._id === id || n.id === id));
      if(!found) return alert('News introuvable');
      nId.value = found._id || found.id || '';
      nTitle.value = found.title || '';
      nDesc.value = htmlBrToText(found.description || '');
      nContent.value = htmlBrToText(found.content || '');
      if(found.image){ nPreview.src = found.image; nPreview.style.display = 'block'; }
      publishBtn.style.display='none'; updateBtn.style.display='inline-block';
      window.scrollTo({ top: 140, behavior: 'smooth' });
    };

    updateBtn.addEventListener('click', async () => {
      const id = nId.value; if(!id) return alert('Aucune news sélectionnée');
      updateBtn.disabled = true; publishStatus.innerText = 'Mise à jour...';
      try {
        let imageUrl = '', publicId = '';
        if(nFile.files && nFile.files[0]){ const up = await uploadFileToServer(nFile.files[0]); imageUrl = up.url; publicId = up.public_id; }
        const body = {
          id,
          title: nTitle.value.trim(),
          description: textToHtmlWithBr(nDesc.value.trim()),
          content: textToHtmlWithBr(nContent.value.trim()),
          image: imageUrl,
          image_public_id: publicId
        };
        const res = await authFetch('/admin/news', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){ toast('Modification réussie'); clearNewsForm(); loadNews(); } else { console.error('update failed', res, j); toast('Erreur', false); alert((j && j.message) || 'Erreur'); }
      } catch(e){ console.error(e); toast('Erreur update', false); }
      finally{ updateBtn.disabled=false; publishStatus.innerText=''; }
    });

    // delegated news actions (edit/delete) using data-id to avoid inline onclick issues
    // renderNewsList will place elements with data attributes; here we bind high-level delegation to news-list container
    function renderNewsList(news){
      if(!news || news.length === 0){ newsList.innerHTML = '<div class="tiny muted">Aucune news</div>'; return; }
      window.__newsCache = news;
      newsList.innerHTML = news.map(n => {
        const nid = (n._id || n.id || '');
        const when = new Date(n.date || n.createdAt || Date.now()).toLocaleString();
        return `
          <div class="news-item" data-id="${escapeHtml(nid)}">
            ${n.image ? `<img class="news-thumb" src="${escapeHtml(n.image)}" alt="">` : `<div class="news-thumb"></div>`}
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="min-width:0">
                  <strong style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(n.title)}</strong>
                  <div class="tiny muted" style="margin-top:4px;white-space:normal">${n.description ? String(n.description) : ''}</div>
                </div>
                <div class="tiny muted" style="margin-left:12px">${when}</div>
              </div>
              <div style="margin-top:8px;color:var(--text);white-space:pre-wrap">${n.content ? String(n.content) : ''}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn" data-news-id="${escapeHtml(nid)}" data-news-action="edit">Modifier</button>
              <button class="btn ghost" data-news-id="${escapeHtml(nid)}" data-news-action="delete">Supprimer</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // delegate news edit/delete clicks
    newsList.addEventListener('click', (ev) => {
      const editBtn = ev.target.closest('[data-news-action]');
      if(!editBtn) return;
      const action = editBtn.getAttribute('data-news-action');
      const id = editBtn.getAttribute('data-news-id');
      if(!id) { toast('ID news introuvable', false); return; }
      if(action === 'edit') return editNews(id);
      if(action === 'delete') {
        if(!confirm('Supprimer cette news ?')) return;
        deleteNews(id);
      }
    });

    // deleteNews uses id; guard if missing
    async function deleteNews(id){
      if(!id){ toast('ID news invalide', false); return; }
      try {
        const res = await authFetch('/admin/news/' + id, { method:'DELETE' });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){ toast('Suppression réussie'); loadNews(); } else { console.error('deleteNews failed', res, j); toast('Erreur suppression', false); alert((j && j.message) || 'Erreur'); }
      } catch(e){ console.error('deleteNews err', e); toast('Erreur suppression', false); }
    }

    async function loadNews(){
      try {
        const res = await authFetch('/admin/news');
        if(!res.ok) throw new Error('Impossible de charger news');
        const news = await res.json();
        renderNewsList(news);
      } catch(e){ console.error(e); newsList.innerHTML = '<div class="tiny muted">Erreur chargement news</div>'; }
    }

    /* ---------------------------
       RATE logic + search
       --------------------------- */
    let ratesCache = [];
    async function loadRates(){
      try {
        const res = await fetch('/api/rates');
        const rates = await res.json();
        ratesCache = Array.isArray(rates) ? rates : [];
        renderRatesList(ratesCache);
      } catch (e){ console.error(e); ratesList.innerHTML = '<div class="tiny muted">Erreur chargement</div>'; }
    }

    function renderRatesList(list){
      const q = ratesFilter.value.trim().toLowerCase();
      const filtered = list.filter(r => !q || r.pair.toLowerCase().includes(q) || String(r.rate).toLowerCase().includes(q));
      if(!filtered || filtered.length === 0){ ratesList.innerHTML = '<div class="tiny muted">Aucun taux</div>'; return; }
      ratesList.innerHTML = filtered.map(r => `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(r.pair)}</strong><div class="tiny muted">${escapeHtml(r.desc||'')}</div></div><div><strong>${escapeHtml(String(r.rate))}</strong></div></div>`).join('');
    }

    ratesFilter.addEventListener('input', ()=> renderRatesList(ratesCache));
    ratesRefreshBtn.addEventListener('click', ()=> loadRates());

    rAdd.addEventListener('click', async () => {
      const pair = rPair.value.trim(); const rate = parseFloat(rValue.value);
      if(!pair || isNaN(rate)) return alert('Pair et valeur requis');
      try {
        const res = await authFetch('/admin/rates', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ pair, rate }) });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){ toast('Taux ajouté/modifié'); rPair.value=''; rValue.value=''; loadRates(); } else { console.error('rates add failed', res, j); toast('Erreur rates', false); }
      } catch(e){ console.error(e); toast('Erreur', false); }
    });

    /* ---------------------------
       PAYMENTS management (admin)
       - use delegation to ensure buttons always work
       --------------------------- */
    let paymentsCache = [];

    async function loadPayments(){
      try {
        const res = await authFetch('/admin/payment-methods');
        if(!res.ok) throw new Error('Impossible de charger paiements');
        const body = await res.json();
        if(!body || !body.success) { pmListEl.innerHTML = '<div class="tiny muted">Aucune méthode</div>'; paymentsCache = []; return; }
        paymentsCache = Array.isArray(body.methods) ? body.methods : [];
        renderPayments();
      } catch (e) {
        console.error(e); pmListEl.innerHTML = '<div class="tiny muted">Erreur chargement</div>'; paymentsCache = [];
      }
    }

    function renderPayments(){
      const q = pmSearch.value.trim().toLowerCase();
      const filtered = paymentsCache.filter(p => {
        if(!q) return true;
        return (p.name||'').toLowerCase().includes(q) || (p.network||'').toLowerCase().includes(q);
      });
      if(!filtered || filtered.length === 0){ pmListEl.innerHTML = '<div class="tiny muted">Aucune méthode</div>'; return; }

      pmListEl.innerHTML = filtered.map(p => {
        const id = p._id || p.id || '';
        const n = p.network ? ` (${escapeHtml(p.network)})` : '';
        const details = p.details ? `<div class="meta">${escapeHtml(p.details)}</div>` : '';
        return `<div class="payment-item" data-pmid="${escapeHtml(id)}">
          <div style="min-width:0">
            <div style="display:flex;align-items:center;gap:8px"><strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.name)}</strong>${n}${p.active ? '<span class="tiny" style="margin-left:8px;color:green">● actif</span>' : '<span class="tiny" style="margin-left:8px;color:#999">● inactif</span>'}</div>
            ${details}
          </div>
          <div class="actions">
            <button class="btn" data-pm-id="${escapeHtml(id)}" data-pm-action="edit">Modifier</button>
            <button class="btn ghost" data-pm-id="${escapeHtml(id)}" data-pm-action="delete">Supprimer</button>
          </div>
        </div>`;
      }).join('');
    }

    // delegate clicks inside pmListEl
    pmListEl.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-pm-action]');
      if(!btn) return;
      const action = btn.getAttribute('data-pm-action');
      const id = btn.getAttribute('data-pm-id');
      if(!id){ toast('ID méthode introuvable', false); return; }
      if(action === 'edit') return fillPaymentForm(id);
      if(action === 'delete') return deletePaymentMethod(id);
    });

    function fillPaymentForm(id){
      const found = paymentsCache.find(p => String(p._id) === String(id) || String(p.id) === String(id));
      if(!found) return toast('Méthode introuvable', false);
      pmId.value = found._id || found.id || '';
      pmName.value = found.name || '';
      pmType.value = found.type || 'fiat';
      pmNetwork.value = found.network || '';
      pmDetails.value = found.details || '';
      pmActive.checked = !!found.active;
      pmName.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearPaymentForm(){
      pmId.value = ''; pmName.value=''; pmType.value='fiat'; pmNetwork.value=''; pmDetails.value=''; pmActive.checked=true;
    }

    pmClear.addEventListener('click', (e) => {
      e.preventDefault();
      clearPaymentForm();
    });

    pmSave.addEventListener('click', async (e) => {
      e.preventDefault();
      const id = pmId.value || null;
      const name = pmName.value.trim();
      const type = pmType.value;
      const network = pmNetwork.value.trim();
      const details = pmDetails.value.trim();
      const active = !!pmActive.checked;
      if(!name) return alert('Nom requis');
      try {
        const payload = { id, name, type, network, details, active };
        const res = await authFetch('/admin/payment-methods', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){
          toast('Méthode enregistrée');
          clearPaymentForm();
          loadPayments();
        } else {
          console.error('pm save failed', res, j);
          toast('Erreur sauvegarde', false);
        }
      } catch (err) {
        console.error(err);
        toast('Erreur serveur', false);
      }
    });

    async function deletePaymentMethod(id){
      if(!id) { toast('ID méthode introuvable', false); return; }
      if(!confirm('Supprimer cette méthode de paiement ?')) return;
      try {
        const res = await authFetch('/admin/payment-methods/' + id, { method:'DELETE' });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){
          toast('Méthode supprimée');
          loadPayments();
        } else { console.error('pm delete failed', res, j); toast('Erreur suppression', false); }
      } catch(e){ console.error(e); toast('Erreur', false); }
    }

    pmRefresh.addEventListener('click', () => { loadPayments(); });
    pmSearch.addEventListener('input', () => renderPayments());

    /* ---------------------------
       helpers / bindings
       --------------------------- */
    $('#btn-logout').addEventListener('click', ()=> { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href='/login_admin'; });
    $('#btn-load-news').addEventListener('click', loadNews);
    $('#btn-seed-sample').addEventListener('click', async () => {
      if(!confirm('Créer une news test ?')) return;
      try {
        const body = { title: 'News test ' + new Date().toLocaleTimeString(), description:'sample', content:'contenu sample' };
        const res = await authFetch('/admin/news', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        const j = await res.json().catch(()=>null);
        if(res.ok && j && j.success){ toast('Seed OK'); loadNews(); } else { toast('Erreur seed', false); console.error('seed failed', res, j); }
      } catch(e){ console.error(e); toast('Erreur', false); }
    });

    // Extend 'btn-refresh' to include payments
    $('#btn-refresh').addEventListener('click', ()=> { loadNews(); loadRates(); loadPayments(); });
    $('#btn-refresh-tx').addEventListener('click', ()=> { loadTransactions(); });

    // nav buttons scroll
    document.querySelectorAll('.admin-top-nav .nav-btn').forEach(b => {
      b.addEventListener('click', (e) => {
        document.querySelectorAll('.admin-top-nav .nav-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        const t = b.getAttribute('data-target');
        const el = document.getElementById(t);
        if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // initial load
    // ok
    loadTransactions(); loadNews(); loadRates(); loadPayments();

    // Expose functions for inline/backwards compatibility if needed
    window.editNews = editNews; window.deleteNews = deleteNews; window.viewTx = viewTx; window.setStatus = setStatus;
  })();
  </script>
</body>
</html>
